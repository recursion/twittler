<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="twittler.css">
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="jquery.timeago.js"></script>
  </head>
  <body>
    <script>

      $(document).ready(function() {
        var $body = $('body');
        $body.html('');

        // Container section for tweet divs
        var $section = $('<section></section>');
        $section.addClass('container');
        $section.appendTo($body);

        // Interval variables
        var updateTimestampsInterval = 1000;
        var updateTweetsInterval = 500;

        // Initial tweet count
        var tweetCount = streams.home.length;

        /* USER INFO WINDOW */
        // blurred layer behind the userinfo window
        var $blurredLayer = $('<div></div>');
        $blurredLayer.addClass('blurredLayer');
        $blurredLayer.appendTo($body);
        $blurredLayer.hide();
        // modal window for viewing user timelines
        var $userInfoPopup = $('<div></div>');
        $userInfoPopup.addClass('userInfoPopup');
        $userInfoPopup.appendTo($body);
        $userInfoPopup.hide();
        // button for closing user info window
        var $closeUserInfoPopupButton = $('<button></button>');
        $closeUserInfoPopupButton.text('X');
        $closeUserInfoPopupButton.addClass('closeUserInfoPopupButton');
        $closeUserInfoPopupButton.appendTo($userInfoPopup);



        // ***************************
        // updateTweets
        // ***************************
        // startCount is the point in the tweets array that we want to update to.
        // we always start updating from the last tweet
        // so  if we wanted to update all tweets, we would use 0.
        // generally though, we will be updating to the last spot we started updating from.
        // .i.e. the place in the array we previously started updating from.
        var updateTweets = function(startCount) {

          var index = streams.home.length - 1;
          while(index >= startCount){

            var tweet = streams.home[index];
            var $tweet = $('<div></div>');
            $tweet.addClass('tweet');

            $tweet.html('<time data-time="' + tweet.created_at + '">' + jQuery.timeago(tweet.created_at) + '</time>: <a href="#">@' + tweet.user + '</a>: ' + tweet.message);
            $tweet.prependTo($section);

            // Username clicked event handler
            $tweet.on('click', 'a', usernameClickHandler);

            index -= 1;
          }
        };

        // Initial tweet update - so we are updating from the current end of the streams.home array
        // all the way to the zeroeth element of said array.
        updateTweets(0);

        // Update tweets
        // Run every <updateInterval> seconds to update any new tweets.
        var tweetsInterval = setInterval(function() {
          if (streams.home.length > tweetCount) {
            updateTweets(tweetCount);
          }
          tweetCount = streams.home.length;
        }, updateTweetsInterval);

        // update timestamps
        var updateTimestamps = setInterval(function() {
          var timeStamps = $('time');
          for (var i = 0; i < timeStamps.length; i++) {
            // create a new data from the original created_at data-time data and pass it to timeago()
            $(timeStamps[i]).text(jQuery.timeago(new Date($(timeStamps[i]).data('time'))));
          }
        }, updateTimestampsInterval);



        $('.closeUserInfoPopupButton').on('click', function(event) {
          event.stopPropagation();
          event.preventDefault();
          $blurredLayer.hide();
          $userInfoPopup.hide();
        });

        var usernameClickHandler = function(event) {
          event.stopPropagation();
          event.preventDefault();
          $blurredLayer.show();
          $userInfoPopup.show();
          console.log($(this).text());
        };

      });




    </script>
  </body>
</html>
